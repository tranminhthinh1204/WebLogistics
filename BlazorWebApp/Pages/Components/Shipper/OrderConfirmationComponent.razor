@using BlazorWebApp.ViewModel
@using BlazorWebApp.Services
@using MudBlazor
@inject ShipmentService ShipmentService
@inject ISnackbar Snackbar

<MudPaper Elevation="2" Class="pa-4 mb-4">
    <MudText Typo="Typo.h6" Class="mb-3">
        <MudIcon Icon="@Icons.Material.Filled.Assignment" Class="mr-2" />
        Nh·∫≠n ƒë∆°n h√†ng m·ªõi
        @if (ShipperId > 0)
        {
            <MudChip T="string" Size="Size.Small" Color="Color.Info" Class="ml-2">
                Shipper ID: @ShipperId
            </MudChip>
        }
        @if (isConnected)
        {
            <MudChip T="string" Size="Size.Small" Color="Color.Success" Class="ml-2">
                <MudIcon Icon="@Icons.Material.Filled.Wifi" Size="Size.Small" Class="mr-1" />
                Live
            </MudChip>
        }
        <!-- ‚úÖ TH√äM REAL-TIME INDICATOR -->
        @if (hasRecentUpdate)
        {
            <MudChip T="string" Size="Size.Small" Color="Color.Warning" Class="ml-2">
                <MudIcon Icon="@Icons.Material.Filled.FiberNew" Size="Size.Small" Class="mr-1" />
                Updated
            </MudChip>
        }
    </MudText>
    
    <!-- ‚úÖ INPUT SECTION -->
    <MudGrid AlignItems="Center" Class="mb-4">
        <MudItem xs="12" md="6">
            <MudTextField @bind-Value="orderCodeInput" 
                         Label="Nh·∫≠p m√£ ƒë∆°n h√†ng" 
                         Variant="Variant.Outlined" 
                         Adornment="Adornment.Start" 
                         AdornmentIcon="@Icons.Material.Filled.QrCodeScanner"
                         HelperText="Nh·∫≠p Order ID ho·∫∑c Order Code"
                         @onkeypress="OnKeyPress" />
        </MudItem>
        <MudItem xs="12" md="3">
            <MudButton Variant="Variant.Filled" 
                      Color="Color.Primary" 
                      StartIcon="@Icons.Material.Filled.Search"
                      OnClick="CheckOrder"
                      Disabled="isChecking || string.IsNullOrWhiteSpace(orderCodeInput) || ShipperId <= 0"
                      FullWidth="true">
                @if (isChecking)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                    <span class="ml-2">ƒêang ki·ªÉm tra...</span>
                }
                else
                {
                    <span>Ki·ªÉm tra ƒë∆°n h√†ng</span>
                }
            </MudButton>
        </MudItem>
        <MudItem xs="12" md="3">
            <MudButton Variant="Variant.Outlined" 
                      Color="Color.Secondary" 
                      StartIcon="@Icons.Material.Filled.Clear"
                      OnClick="ClearForm"
                      Disabled="isChecking"
                      FullWidth="true">
                X√≥a
            </MudButton>
        </MudItem>
    </MudGrid>

    <!-- ‚úÖ VALIDATION SECTION -->
    @if (ShipperId <= 0)
    {
        <MudAlert Severity="Severity.Warning" Class="mb-4">
            <MudText Typo="Typo.h6">‚ö†Ô∏è Kh√¥ng th·ªÉ x√°c ƒë·ªãnh th√¥ng tin shipper</MudText>
            <MudText>Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i ho·∫∑c li√™n h·ªá admin ƒë·ªÉ ƒë∆∞·ª£c c·∫•p quy·ªÅn shipper.</MudText>
        </MudAlert>
        return;
    }

    <!-- ‚úÖ ORDER PREVIEW SECTION -->
    @if (orderPreview != null)
    {
        <MudDivider Class="mb-4" />
        
        <!-- Order Status Summary -->
        <MudAlert Severity="GetOrderSeverity()" Class="mb-4">
            <div class="d-flex align-center">
                <MudIcon Icon="GetOrderIcon()" Size="Size.Large" Class="mr-3" />
                <div class="flex-grow-1">
                    <MudText Typo="Typo.h6">@GetOrderStatusMessage()</MudText>
                    <MudText Typo="Typo.body2">@GetOrderStatusDescription()</MudText>
                    <div class="d-flex align-center mt-1">
                        @if (lastCheckTime.HasValue)
                        {
                            <MudText Typo="Typo.caption" Color="Color.Secondary">
                                Ki·ªÉm tra l√∫c: @lastCheckTime.Value.ToString("HH:mm:ss dd/MM/yyyy")
                            </MudText>
                        }
                        @if (lastSignalRUpdate.HasValue)
                        {
                            <MudText Typo="Typo.caption" Color="Color.Info" Class="ml-3">
                                <MudIcon Icon="@Icons.Material.Filled.Sync" Size="Size.Small" Class="mr-1" />
                                Real-time: @lastSignalRUpdate.Value.ToString("HH:mm:ss")
                            </MudText>
                        }
                        @if (hasRecentUpdate)
                        {
                            <MudIcon Icon="@Icons.Material.Filled.FiberNew" Color="Color.Warning" Size="Size.Small" Class="ml-2" />
                        }
                    </div>
                </div>
            </div>
        </MudAlert>
        
        <MudGrid>
            <!-- Order Information -->
            <MudItem xs="12" md="8">
                <MudPaper Elevation="1" Class="pa-4">
                    <MudText Typo="Typo.h6" Class="mb-3">
                        <MudIcon Icon="@Icons.Material.Filled.Receipt" Class="mr-2" />
                        Th√¥ng tin ƒë∆°n h√†ng #@orderPreview.OrderInfo.OrderId
                        <MudChip T="string" 
                                Size="Size.Small" 
                                Color="GetStatusColor(orderPreview.OrderInfo.OrderStatusId)"
                                Class="ml-2">
                            @orderPreview.OrderInfo.CurrentOrderStatus
                            @if (hasRecentStatusUpdate)
                            {
                                <MudIcon Icon="@Icons.Material.Filled.FiberNew" Size="Size.Small" Class="ml-1" />
                            }
                        </MudChip>
                    </MudText>
                    
                    <MudSimpleTable Dense="true" Hover="true" Class="mb-3">
                        <tbody>
                            <tr>
                                <td width="30%"><strong>M√£ ƒë∆°n h√†ng:</strong></td>
                                <td>ORD-@orderPreview.OrderInfo.OrderId.ToString("D4")</td>
                            </tr>
                            <tr>
                                <td><strong>Kh√°ch h√†ng:</strong></td>
                                <td>@orderPreview.BuyerInfo.FullName</td>
                            </tr>
                            <tr>
                                <td><strong>S·ªë ƒëi·ªán tho·∫°i:</strong></td>
                                <td>
                                    <MudLink Href="@($"tel:{orderPreview.BuyerInfo.PhoneNumber}")">
                                        <MudIcon Icon="@Icons.Material.Filled.Phone" Size="Size.Small" Class="mr-1" />
                                        @orderPreview.BuyerInfo.PhoneNumber
                                    </MudLink>
                                </td>
                            </tr>
                            <tr>
                                <td><strong>Email:</strong></td>
                                <td>
                                    <MudLink Href="@($"mailto:{orderPreview.BuyerInfo.Email}")">
                                        <MudIcon Icon="@Icons.Material.Filled.Email" Size="Size.Small" Class="mr-1" />
                                        @orderPreview.BuyerInfo.Email
                                    </MudLink>
                                </td>
                            </tr>
                            <tr>
                                <td><strong>ƒê·ªãa ch·ªâ giao h√†ng:</strong></td>
                                <td>
                                    <div class="d-flex align-center">
                                        <MudIcon Icon="@Icons.Material.Filled.LocationOn" Size="Size.Small" Class="mr-1" />
                                        <span>@orderPreview.ShippingAddress.FullAddress</span>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td><strong>Ng√†y ƒë·∫∑t h√†ng:</strong></td>
                                <td>@orderPreview.OrderInfo.FormattedOrderDate</td>
                            </tr>
                            <tr>
                                <td><strong>Gi√° tr·ªã ƒë∆°n h√†ng:</strong></td>
                                <td>
                                    <MudText Typo="Typo.h6" Color="Color.Success">
                                        @orderPreview.OrderInfo.FormattedTotalAmount
                                    </MudText>
                                </td>
                            </tr>
                            @if (orderPreview.ShipmentInfo != null)
                            {
                                <tr>
                                    <td><strong>Tr·∫°ng th√°i v·∫≠n chuy·ªÉn:</strong></td>
                                    <td>
                                        <MudChip T="string" Size="Size.Small" Color="Color.Info" Class="mr-2">
                                            @orderPreview.ShipmentInfo.Status
                                            @if (hasRecentShipmentUpdate)
                                            {
                                                <MudIcon Icon="@Icons.Material.Filled.FiberNew" Size="Size.Small" Class="ml-1" />
                                            }
                                        </MudChip>
                                        @if (orderPreview.ShipmentInfo.ShipperId == ShipperId)
                                        {
                                            <MudChip T="string" Size="Size.Small" Color="Color.Success">
                                                C·ªßa b·∫°n
                                            </MudChip>
                                        }
                                    </td>
                                </tr>
                                @if (!string.IsNullOrEmpty(orderPreview.ShipmentInfo.TrackingNumber))
                                {
                                    <tr>
                                        <td><strong>M√£ v·∫≠n ƒë∆°n:</strong></td>
                                        <td>
                                            <MudText Typo="Typo.body1" Class="font-weight-bold">
                                                @orderPreview.ShipmentInfo.TrackingNumber
                                            </MudText>
                                        </td>
                                    </tr>
                                }
                            }
                        </tbody>
                    </MudSimpleTable>

                    <!-- Order Items Summary -->
                    <MudText Typo="Typo.subtitle1" Class="mb-2">
                        <MudIcon Icon="@Icons.Material.Filled.Inventory" Class="mr-2" />
                        S·∫£n ph·∫©m (@orderPreview.OrderItems.Count items)
                    </MudText>
                    <MudList T="string" Dense="true" Class="pa-0">
                        @foreach (var item in orderPreview.OrderItems)
                        {
                            <MudListItem T="string" Class="pa-2" Style="border-bottom: 1px solid #eee;">
                                <div class="d-flex justify-space-between align-center">
                                    <div>
                                        <MudText Typo="Typo.body2" Class="font-weight-bold">@item.ProductName</MudText>
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                                            @item.Quantity x @item.FormattedUnitPrice
                                        </MudText>
                                    </div>
                                    <MudText Typo="Typo.body2" Class="font-weight-bold">
                                        @item.FormattedTotalPrice
                                    </MudText>
                                </div>
                            </MudListItem>
                        }
                    </MudList>
                </MudPaper>
            </MudItem>
            
            <!-- Eligibility Check -->
            <MudItem xs="12" md="4">
                <MudPaper Elevation="1" Class="pa-4">
                    <MudText Typo="Typo.h6" Class="mb-3">
                        <MudIcon Icon="@Icons.Material.Filled.ChecklistRtl" Class="mr-2" />
                        Ki·ªÉm tra ƒëi·ªÅu ki·ªán
                        @if (isAutoRefreshing)
                        {
                            <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="ml-2" />
                        }
                    </MudText>
                    
                    <MudList T="string" Dense="true">
                        <!-- Order Status Check -->
                        <MudListItem T="string" 
                                   Icon="@(canShip ? Icons.Material.Filled.CheckCircle : Icons.Material.Filled.Cancel)"
                                   IconColor="@(canShip ? Color.Success : Color.Error)">
                            <MudText Typo="Typo.body2" Color="@(canShip ? Color.Success : Color.Error)">
                                @(canShip ? "‚úÖ ƒê∆°n h√†ng c√≥ th·ªÉ ship" : "‚ùå ƒê∆°n h√†ng kh√¥ng th·ªÉ ship")
                            </MudText>
                        </MudListItem>
                        
                        <!-- Shipment Assignment Check -->
                        <MudListItem T="string" 
                                   Icon="@GetShipmentIcon()"
                                   IconColor="@GetShipmentIconColor()">
                            <MudText Typo="Typo.body2" Color="@GetShipmentIconColor()">
                                @GetShipmentStatusText()
                            </MudText>
                        </MudListItem>

                        <!-- Shipper Info -->
                        <MudListItem T="string" Icon="@Icons.Material.Filled.Person" IconColor="Color.Info">
                            <MudText Typo="Typo.body2" Color="Color.Info">
                                Shipper hi·ªán t·∫°i: #@ShipperId
                            </MudText>
                        </MudListItem>

                        <!-- ‚úÖ TH√äM SIGNALR STATUS TRACKING -->
                        @if (signalREventCount > 0)
                        {
                            <MudListItem T="string" Icon="@Icons.Material.Filled.Sync" IconColor="Color.Secondary">
                                <MudText Typo="Typo.body2" Color="Color.Secondary">
                                    SignalR events: @signalREventCount
                                </MudText>
                            </MudListItem>
                        }

                        <!-- Status Change Count -->
                        @if (statusChangeCount > 0)
                        {
                            <MudListItem T="string" Icon="@Icons.Material.Filled.History" IconColor="Color.Secondary">
                                <MudText Typo="Typo.body2" Color="Color.Secondary">
                                    ƒê√£ ki·ªÉm tra @statusChangeCount l·∫ßn
                                </MudText>
                            </MudListItem>
                        }
                    </MudList>
                    
                    <!-- Action Buttons -->
                    <MudDivider Class="my-3" />
                    
                    <MudStack Spacing="2">
                        <!-- Refresh Button -->
                        <MudButton StartIcon="@Icons.Material.Filled.Refresh" 
                                  Variant="Variant.Text" 
                                  Color="Color.Secondary"
                                  OnClick="RefreshCurrentOrder"
                                  Disabled="isAutoRefreshing || isChecking"
                                  FullWidth="true"
                                  Size="Size.Small">
                            L√†m m·ªõi th√¥ng tin
                        </MudButton>

                        <!-- Main Action Button -->
                        @if (CanConfirmPickup())
                        {
                            <MudButton Color="Color.Success"
                                      Variant="Variant.Filled"
                                      StartIcon="@Icons.Material.Filled.TaskAlt"
                                      OnClick="ConfirmPickupOrder"
                                      Disabled="isConfirming"
                                      FullWidth="true">
                                @if (isConfirming)
                                {
                                    <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                                    <span class="ml-2">ƒêang x√°c nh·∫≠n...</span>
                                }
                                else
                                {
                                    <span>üöö X√°c nh·∫≠n nh·∫≠n ƒë∆°n</span>
                                }
                            </MudButton>
                        }
                        else if (IsAlreadyAssignedToMe())
                        {
                            <MudAlert Severity="Severity.Success" Dense="true">
                                <MudText Typo="Typo.body2">
                                    ‚úÖ B·∫°n ƒë√£ ƒë∆∞·ª£c assign ƒë∆°n h√†ng n√†y
                                </MudText>
                            </MudAlert>
                        }
                        else if (IsAssignedToOther())
                        {
                            <MudAlert Severity="Severity.Warning" Dense="true">
                                <MudText Typo="Typo.body2">
                                    ‚ö†Ô∏è ƒê∆°n h√†ng ƒë√£ ƒë∆∞·ª£c assign cho shipper kh√°c
                                </MudText>
                            </MudAlert>
                        }
                        else if (!canShip)
                        {
                            <MudAlert Severity="Severity.Error" Dense="true">
                                <MudText Typo="Typo.body2">
                                    ‚ùå ƒê∆°n h√†ng ch∆∞a s·∫µn s√†ng ƒë·ªÉ ship
                                </MudText>
                            </MudAlert>
                        }
                    </MudStack>
                </MudPaper>
            </MudItem>
        </MudGrid>
    }
    else if (!string.IsNullOrWhiteSpace(orderCodeInput) && !isChecking)
    {
        <!-- No Results -->
        <MudAlert Severity="Severity.Info" Class="mt-4">
            <MudText Typo="Typo.h6">‚ÑπÔ∏è Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng</MudText>
            <MudText>Vui l√≤ng ki·ªÉm tra l·∫°i m√£ ƒë∆°n h√†ng ho·∫∑c b·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p ƒë∆°n h√†ng n√†y.</MudText>
        </MudAlert>
    }
</MudPaper>

@code {
    [Parameter] public int ShipperId { get; set; }
    [Parameter] public EventCallback<ShipmentDashboardVM> OnOrderConfirmed { get; set; }
    [Parameter] public bool isConnected { get; set; } = false;
    
    private string orderCodeInput = string.Empty;
    private bool isChecking = false;
    private bool isConfirming = false;
    private bool isAutoRefreshing = false;
    private bool canShip = false;
    private bool hasRecentUpdate = false;
    private bool hasRecentStatusUpdate = false; // ‚úÖ TH√äM FLAG CHO ORDER STATUS UPDATE
    private bool hasRecentShipmentUpdate = false; // ‚úÖ TH√äM FLAG CHO SHIPMENT STATUS UPDATE
    private ShipmentDashboardVM? orderPreview;
    private DateTime? lastCheckTime;
    private DateTime? lastSignalRUpdate; // ‚úÖ TH√äM TIMESTAMP CHO SIGNALR UPDATE
    private int statusChangeCount = 0;
    private int signalREventCount = 0; // ‚úÖ ƒê·∫æM S·ªê L·∫¶N NH·∫¨N SIGNALR EVENT

    // ‚úÖ PUBLIC METHOD FOR SIGNALR ORDER STATUS UPDATES
    public async Task OnYourOrderStatusChanged(int orderId, int userId, int statusId, string statusName)
    {
        Console.WriteLine($"üîî OrderConfirmation: Received YourOrderStatusChanged - Order: {orderId}, Status: {statusName}, User: {userId}, Status ID: {statusId}");

        if (orderPreview?.OrderInfo.OrderId == orderId)
        {
            await InvokeAsync(async () =>
            {
                signalREventCount++;
                hasRecentUpdate = true;
                hasRecentStatusUpdate = true;
                lastSignalRUpdate = DateTime.Now;
                
                Snackbar.Add($"üîî Order #{orderId}: {statusName}", Severity.Info);
                
                // ‚úÖ T·ª∞ ƒê·ªòNG REFRESH ORDER ƒê·ªÇ L·∫§Y DATA M·ªöI NH·∫§T
                await RefreshCurrentOrderSilent();
                
                StateHasChanged();
                
                // ‚úÖ AUTO-HIDE STATUS UPDATE INDICATOR AFTER 10 SECONDS
                _ = Task.Delay(10000).ContinueWith(_ =>
                {
                    InvokeAsync(() =>
                    {
                        hasRecentStatusUpdate = false;
                        StateHasChanged();
                    });
                });
            });
        }
    }

    // ‚úÖ PUBLIC METHOD FOR SIGNALR SHIPMENT STATUS UPDATES
    public async Task OnShipmentStatusUpdated(int shipmentId, int orderId, string status)
    {
        Console.WriteLine($"üîî OrderConfirmation: Received ShipmentStatusUpdated - Shipment: {shipmentId}, Order: {orderId}, Status: {status}");
        
        if (orderPreview?.OrderInfo.OrderId == orderId)
        {
            await InvokeAsync(async () =>
            {
                signalREventCount++;
                hasRecentUpdate = true;
                hasRecentShipmentUpdate = true;
                lastSignalRUpdate = DateTime.Now;
                
                Snackbar.Add($"üöö Shipment #{shipmentId}: {status}", Severity.Info);
                
                // ‚úÖ T·ª∞ ƒê·ªòNG REFRESH ORDER ƒê·ªÇ L·∫§Y DATA M·ªöI NH·∫§T
                await RefreshCurrentOrderSilent();
                
                StateHasChanged();
                
                // ‚úÖ AUTO-HIDE SHIPMENT UPDATE INDICATOR AFTER 10 SECONDS
                _ = Task.Delay(10000).ContinueWith(_ =>
                {
                    InvokeAsync(() =>
                    {
                        hasRecentShipmentUpdate = false;
                        StateHasChanged();
                    });
                });
            });
        }
    }

    // ‚úÖ GENERAL REFRESH ORDER METHOD (FROM PARENT SIGNALR)
    public async Task RefreshOrderIfMatch(int orderId)
    {
        if (orderPreview?.OrderInfo.OrderId == orderId)
        {
            Console.WriteLine($"üîÑ OrderConfirmation: General refresh for order {orderId}");
            
            await InvokeAsync(async () =>
            {
                signalREventCount++;
                hasRecentUpdate = true;
                lastSignalRUpdate = DateTime.Now;
                
                await RefreshCurrentOrderSilent();
                
                StateHasChanged();
            });
        }
    }

    // ‚úÖ MAIN CHECK ORDER METHOD
    private async Task CheckOrder()
    {
        if (string.IsNullOrWhiteSpace(orderCodeInput))
        {
            Snackbar.Add("Vui l√≤ng nh·∫≠p m√£ ƒë∆°n h√†ng", Severity.Warning);
            return;
        }

        if (ShipperId <= 0)
        {
            Snackbar.Add("Kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c th√¥ng tin shipper", Severity.Error);
            return;
        }

        isChecking = true;
        ResetUpdateFlags();
        
        try
        {
            // Parse order ID from input (support both "123" and "ORD-000123" formats)
            var orderId = ParseOrderId(orderCodeInput);
            if (orderId <= 0)
            {
                Snackbar.Add("M√£ ƒë∆°n h√†ng kh√¥ng h·ª£p l·ªá", Severity.Warning);
                return;
            }

            Console.WriteLine($"üîç Checking order {orderId} for shipper {ShipperId}...");
            
            // Get order details
            orderPreview = await ShipmentService.GetShipmentDashboardByOrderIdAsync(orderId);
            
            if (orderPreview == null)
            {
                Snackbar.Add("Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng ho·∫∑c b·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p", Severity.Warning);
                ClearOrderData();
                return;
            }

            // Check shipping eligibility
            canShip = await ShipmentService.CanOrderBeShippedAsync(orderId);
            lastCheckTime = DateTime.Now;
            statusChangeCount++;

            // Show appropriate message
            ShowCheckResult();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ùå Error checking order: {ex.Message}");
            Snackbar.Add($"L·ªói ki·ªÉm tra ƒë∆°n h√†ng: {ex.Message}", Severity.Error);
            ClearOrderData();
        }
        finally
        {
            isChecking = false;
        }
    }

    // ‚úÖ REFRESH CURRENT ORDER (MANUAL)
    private async Task RefreshCurrentOrder()
    {
        if (orderPreview == null) return;

        isAutoRefreshing = true;
        
        try
        {
            await RefreshCurrentOrderInternal(showNotifications: true);
        }
        finally
        {
            isAutoRefreshing = false;
        }
    }

    // ‚úÖ REFRESH CURRENT ORDER (SILENT - FOR SIGNALR)
    private async Task RefreshCurrentOrderSilent()
    {
        if (orderPreview == null) return;
        
        await RefreshCurrentOrderInternal(showNotifications: false);
    }

    // ‚úÖ INTERNAL REFRESH METHOD
    private async Task RefreshCurrentOrderInternal(bool showNotifications = true)
    {
        if (orderPreview == null) return;

        try
        {
            var orderId = orderPreview.OrderInfo.OrderId;
            Console.WriteLine($"üîÑ Refreshing order {orderId}... (Notifications: {showNotifications})");
            
            var previousStatus = orderPreview.OrderInfo.CurrentOrderStatus;
            var previousShipmentStatus = orderPreview.ShipmentInfo?.Status;
            var previousShipperId = orderPreview.ShipmentInfo?.ShipperId;
            
            // Reload order data
            var newOrderData = await ShipmentService.GetShipmentDashboardByOrderIdAsync(orderId);
            
            if (newOrderData != null)
            {
                orderPreview = newOrderData;
                canShip = await ShipmentService.CanOrderBeShippedAsync(orderId);
                lastCheckTime = DateTime.Now;

                // ‚úÖ DETECT CHANGES
                bool statusChanged = previousStatus != orderPreview.OrderInfo.CurrentOrderStatus;
                bool shipmentStatusChanged = previousShipmentStatus != orderPreview.ShipmentInfo?.Status;
                bool shipmentAssignmentChanged = previousShipperId != orderPreview.ShipmentInfo?.ShipperId;

                if (showNotifications)
                {
                    if (statusChanged)
                    {
                        Console.WriteLine($"‚úÖ Order status changed: {previousStatus} ‚Üí {orderPreview.OrderInfo.CurrentOrderStatus}");
                        Snackbar.Add($"üìä Tr·∫°ng th√°i ƒë∆°n h√†ng: {orderPreview.OrderInfo.CurrentOrderStatus}", Severity.Info);
                    }

                    if (shipmentStatusChanged)
                    {
                        Console.WriteLine($"‚úÖ Shipment status changed: {previousShipmentStatus} ‚Üí {orderPreview.ShipmentInfo?.Status}");
                        Snackbar.Add($"üöö Tr·∫°ng th√°i v·∫≠n chuy·ªÉn: {orderPreview.ShipmentInfo?.Status}", Severity.Info);
                    }

                    if (shipmentAssignmentChanged)
                    {
                        Console.WriteLine($"‚úÖ Shipment assignment changed: {previousShipperId} ‚Üí {orderPreview.ShipmentInfo?.ShipperId}");
                        if (orderPreview.ShipmentInfo?.ShipperId == ShipperId)
                        {
                            Snackbar.Add($"üéØ B·∫°n ƒë√£ ƒë∆∞·ª£c assign ƒë∆°n h√†ng #{orderId}!", Severity.Success);
                        }
                        else if (orderPreview.ShipmentInfo?.ShipperId != null)
                        {
                            Snackbar.Add($"‚ö†Ô∏è ƒê∆°n h√†ng ƒë√£ ƒë∆∞·ª£c assign cho shipper #{orderPreview.ShipmentInfo.ShipperId}", Severity.Warning);
                        }
                    }
                }
                
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ùå Error refreshing order: {ex.Message}");
            if (showNotifications)
            {
                Snackbar.Add($"L·ªói l√†m m·ªõi ƒë∆°n h√†ng: {ex.Message}", Severity.Error);
            }
        }
    }

    // ‚úÖ CONFIRM PICKUP ORDER
    private async Task ConfirmPickupOrder()
    {
        if (orderPreview == null || ShipperId <= 0 || !CanConfirmPickup()) return;

        isConfirming = true;
        try
        {
            var success = await ShipmentService.AssignShipmentAsync(orderPreview.OrderInfo.OrderId, ShipperId);

            if (success)
            {
                Snackbar.Add($"‚úÖ ƒê√£ nh·∫≠n ƒë∆°n h√†ng #{orderPreview.OrderInfo.OrderId} th√†nh c√¥ng!", Severity.Success);
                
                // Refresh order data to show updated shipment info
                await RefreshCurrentOrder();
                
                // Notify parent component
                await OnOrderConfirmed.InvokeAsync(orderPreview);
            }
            else
            {
                Snackbar.Add("‚ùå X√°c nh·∫≠n nh·∫≠n ƒë∆°n h√†ng th·∫•t b·∫°i", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ùå Error confirming pickup: {ex.Message}");
            Snackbar.Add($"‚ùå L·ªói x√°c nh·∫≠n: {ex.Message}", Severity.Error);
        }
        finally
        {
            isConfirming = false;
        }
    }

    // ‚úÖ HELPER METHODS
    private int ParseOrderId(string input)
    {
        if (string.IsNullOrWhiteSpace(input)) return 0;
        
        // Remove "ORD-" prefix if present
        var cleaned = input.Trim().ToUpper().Replace("ORD-", "");
        
        return int.TryParse(cleaned, out var orderId) ? orderId : 0;
    }

    private void ShowCheckResult()
    {
        if (orderPreview == null) return;

        if (CanConfirmPickup())
        {
            Snackbar.Add("‚úÖ ƒê∆°n h√†ng ƒë·ªß ƒëi·ªÅu ki·ªán ƒë·ªÉ nh·∫≠n", Severity.Success);
        }
        else if (IsAlreadyAssignedToMe())
        {
            Snackbar.Add("‚ÑπÔ∏è B·∫°n ƒë√£ ƒë∆∞·ª£c assign ƒë∆°n h√†ng n√†y", Severity.Info);
        }
        else if (IsAssignedToOther())
        {
            Snackbar.Add($"‚ö†Ô∏è ƒê∆°n h√†ng ƒë√£ ƒë∆∞·ª£c assign cho shipper #{orderPreview.ShipmentInfo.ShipperId}", Severity.Warning);
        }
        else if (!canShip)
        {
            Snackbar.Add("‚ö†Ô∏è ƒê∆°n h√†ng ch∆∞a s·∫µn s√†ng ƒë·ªÉ ship", Severity.Warning);
        }
    }

    private bool CanConfirmPickup() => canShip && orderPreview?.ShipmentInfo == null;
    private bool IsAlreadyAssignedToMe() => orderPreview?.ShipmentInfo?.ShipperId == ShipperId;
    private bool IsAssignedToOther() => orderPreview?.ShipmentInfo != null && orderPreview.ShipmentInfo.ShipperId != ShipperId;

    private void ResetUpdateFlags()
    {
        hasRecentUpdate = false;
        hasRecentStatusUpdate = false;
        hasRecentShipmentUpdate = false;
    }

    private void ClearForm()
    {
        orderCodeInput = string.Empty;
        ClearOrderData();
    }

    private void ClearOrderData()
    {
        orderPreview = null;
        canShip = false;
        ResetUpdateFlags();
        statusChangeCount = 0;
        signalREventCount = 0;
        lastCheckTime = null;
        lastSignalRUpdate = null;
    }

    private async Task OnKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !isChecking && !string.IsNullOrWhiteSpace(orderCodeInput))
        {
            await CheckOrder();
        }
    }

    // ‚úÖ AUTO-HIDE RECENT UPDATE AFTER 15 SECONDS
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (hasRecentUpdate)
        {
            _ = Task.Delay(15000).ContinueWith(_ =>
            {
                InvokeAsync(() =>
                {
                    hasRecentUpdate = false;
                    StateHasChanged();
                });
            });
        }
    }

    // ‚úÖ UI STATE METHODS
    private Severity GetOrderSeverity() => CanConfirmPickup() ? Severity.Success : 
                                          IsAlreadyAssignedToMe() ? Severity.Info :
                                          IsAssignedToOther() ? Severity.Warning : Severity.Error;

    private string GetOrderIcon() => CanConfirmPickup() ? Icons.Material.Filled.CheckCircle :
                                    IsAlreadyAssignedToMe() ? Icons.Material.Filled.LocalShipping :
                                    IsAssignedToOther() ? Icons.Material.Filled.Warning :
                                    Icons.Material.Filled.Error;

    private string GetOrderStatusMessage() => CanConfirmPickup() ? "C√≥ th·ªÉ nh·∫≠n ƒë∆°n h√†ng" :
                                             IsAlreadyAssignedToMe() ? "ƒê∆°n h√†ng c·ªßa b·∫°n" :
                                             IsAssignedToOther() ? "ƒê√£ c√≥ shipper kh√°c" :
                                             "Kh√¥ng th·ªÉ nh·∫≠n ƒë∆°n";

    private string GetOrderStatusDescription() => CanConfirmPickup() ? "ƒê∆°n h√†ng ƒë·ªß ƒëi·ªÅu ki·ªán ƒë·ªÉ b·∫°n nh·∫≠n ship" :
                                                 IsAlreadyAssignedToMe() ? $"B·∫°n ƒë√£ ƒë∆∞·ª£c assign ƒë∆°n h√†ng n√†y - Tracking: {orderPreview?.ShipmentInfo?.TrackingNumber}" :
                                                 IsAssignedToOther() ? $"ƒê∆°n h√†ng ƒë√£ ƒë∆∞·ª£c assign cho shipper #{orderPreview?.ShipmentInfo?.ShipperId}" :
                                                 "ƒê∆°n h√†ng ch∆∞a s·∫µn s√†ng ho·∫∑c kh√¥ng c√≥ quy·ªÅn truy c·∫≠p";

    private string GetShipmentIcon() => orderPreview?.ShipmentInfo == null ? Icons.Material.Filled.CheckCircle :
                                       IsAlreadyAssignedToMe() ? Icons.Material.Filled.CheckCircle :
                                       Icons.Material.Filled.Cancel;

    private Color GetShipmentIconColor() => orderPreview?.ShipmentInfo == null ? Color.Success :
                                           IsAlreadyAssignedToMe() ? Color.Success : Color.Error;

    private string GetShipmentStatusText() => orderPreview?.ShipmentInfo == null ? "‚úÖ Ch∆∞a c√≥ shipment" :
                                             IsAlreadyAssignedToMe() ? "‚úÖ ƒê√£ assign cho b·∫°n" :
                                             $"‚ùå ƒê√£ assign cho shipper #{orderPreview.ShipmentInfo.ShipperId}";

    private Color GetStatusColor(int statusId) => statusId switch
    {
        1 => Color.Secondary,  // Pending
        2 => Color.Info,       // Processing  
        3 => Color.Primary,    // Ready for Pickup
        4 => Color.Warning,    // Shipped
        5 => Color.Warning,    // In Transit
        6 => Color.Success,    // Out for Delivery
        7 => Color.Success,    // Delivered
        9 => Color.Error,      // Returned
        _ => Color.Default
    };
}